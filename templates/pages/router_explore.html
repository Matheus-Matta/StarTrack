{% extends "base.html" %}
{% load static %}

{% block title %}Explorar Rotas{% endblock %}
{% block css %}
<style>
    .marker-checked {
        opacity: 0.8 !important;
    }
</style>
{% endblock %}
{% block content %}

{% include 'partials/nav/nav_route.html' %}

<div
    class="flex grow rounded-b-xl bg-[--tw-content-bg] dark:bg-[--tw-content-bg-dark] border-x border-b border-gray-400 dark:border-gray-200 lg:mt-[--tw-navbar-height] mx-5 lg:ms-[--tw-sidebar-width] mb-5">
    <div class="flex flex-col grow pt-3 lg:scrollable-y lg:[scrollbar-width:auto] lg:light:[--tw-scrollbar-thumb-color:var(--tw-content-scrollbar-color)] pt-3 lg:[&_.container-fluid]:pe-4"
        id="scrollable_content">
        <main class="grow pb-7" role="content">
            <div class="container-fluid pb-3 flex justify-between items-stretch gap-5">
                <div class="grid items-stretch">
                    <div class="scrollable-x-auto flex items-stretch">
                        <div class="menu gap-5 lg:gap-7.5" data-menu="true">
                            <div class="menu-item" data-menu-item-toggle="dropdown">
                                <span class="menu-title text-nowrap text-sm text-gray-800 font-medium">
                                    Composição: <span class="text-primary ml-2"> #{{ composition.id }}</span>
                                    <span class="text-sm font-medium text-gray-600 ml-4">
                                        Criado em: {{ composition.created_at }}
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="relative flex items-center space-x-4">
                    <label for="routeSelect" class="text-sm font-medium text-gray-600">Selecionar Rota:</label>
                    <select style="width: 200px;" id="routeSelect"
                        class="input bg-white dark:bg-[--tw-content-bg-dark] border border-gray-300 rounded-md text-sm p-2">
                        <option value="all" selected>Todas as Rotas</option>
                        {% for route in routes %}
                        <option value="{{ route.name }}">{{ route.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <!-- Container -->
            <div class="container-fluid">
                <div class="grid gap-5 lg:gap-7.5"> <!-- Altura mínima relativa ao viewport -->
                    <div class="grid lg:grid-cols-3 lg:grid-rows-2 h-full gap-5 lg:gap-7.5 items-stretch">

                        <!-- Mapa -->
                        <div style="height: 720px;" class="lg:col-span-2 row-span-2">
                            <div class="card h-full flex flex-col">
                                <div class="card-body flex-1 flex flex-col place-content-center p-2">
                                    <div class="w-full h-full rounded-xl z-0" id="map" data-routes="{{ routes_json }}"></div>
                                </div>
                            </div>
                        </div>

                        <div style="height: 720px" class="lg:col-span-1 row-span-2">
                            <div class="card h-full flex flex-col">
                                <div class="card-header">
                                    <h3 class="card-title">Lista de Pedidos</h3>
                                    {% with total_pedidos=0 %}
                                    {% for route in routes %}
                                    {% for stop in route.stops %}
                                    {% if not stop.order_number == "SAIDA" %}
                                    {% widthratio total_pedidos|add:1 1 1 as total_pedidos %}
                                    {% endif %}
                                    {% endfor %}
                                    {% endfor %}
                                    {% endwith %}
                                </div>
                                <div
                                    class="card-body flex-1 flex flex-col p-2 overflow-y-auto lg:scrollable-y lg:light:[--tw-scrollbar-thumb-color:var(--tw-content-scrollbar-color)]">
                                    {% for route in routes %}
                                    <h3 data-route="{{ route.name }}"
                                        class="pedido-card text-sm font-semibold text-gray-500 mt-2">{{ route.name }}<i
                                            class="ki-filled ki-arrow-down my-2 ml-3"></i>
                                    </h3>
                                    <div class="space-y-3">
                                        {% for stop in route.stops %}
                                        {% if not stop.order_number == "SAIDA" %}
                                        <div class="pedido-card transition hover:bg-gray-200 border border-gray-300 shadow-sm rounded-lg p-3 cursor-pointer hover:shadow-md"
                                            data-route="{{ route.name }}" data-marker-id="{{ stop.id }}">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <strong class="text-xs inline-block text-gray-500">Pedido: </strong>
                                                    <p class="text-sm inline-block font-semibold text-yellow-600">
                                                        {{ stop.order_number }}
                                                    </p>
                                                </div>
                                                <span class="text-xs text-primary">#{{ stop.position }}</span>
                                            </div>
                                            <div class="text-xs text-gray-700 mt-1">
                                                <strong>{{ stop.client }}</strong><br>
                                                <span class="text-gray-500">{{ stop.address }}</span>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <!-- End of Container -->
        </main>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'assets/js/custom/pages/scripting/explore_routes.js' %}"></script>
{% endblock %}